name: Deploy Reports to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate exports exist
        run: |
          echo "ğŸ” Validating pre-generated reports..."
          
          # Check required directories
          if [ ! -d "research/exports/reports" ]; then
            echo "âŒ ERROR: research/exports/reports/ not found"
            echo "Run: python -m research.src.cli export"
            exit 1
          fi
          
          if [ ! -d "research/exports/visualizations" ]; then
            echo "âŒ ERROR: research/exports/visualizations/ not found"
            echo "Run: python -m research.src.cli export"
            exit 1
          fi
          
          # Check required files (sem timestamps)
          REQUIRED_FILES=(
            "research/exports/reports/summary_report.html"
            "research/exports/reports/papers_report_included.html"
            "research/exports/reports/gap_analysis.html"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ERROR: $file not found"
              echo "Run: python -m research.src.cli export"
              exit 1
            fi
            echo "âœ… Found: $file"
          done
          
          # Validate visualizations
          VIZ_COUNT=$(ls -1 research/exports/visualizations/*.png 2>/dev/null | wc -l)
          if [ "$VIZ_COUNT" -lt 6 ]; then
            echo "âš ï¸ WARNING: Expected 6 visualizations, found $VIZ_COUNT"
          else
            echo "âœ… Found $VIZ_COUNT visualization(s)"
          fi
      
      - name: Prepare Pages content
        run: |
          echo "ğŸ“¦ Preparing content for GitHub Pages..."
          mkdir -p _site
          
          # Copy main index.html (projeto principal)
          cp index.html _site/index.html
          
          # Create research directory structure  
          mkdir -p _site/research
          cp -r research/exports _site/research/
          # Copy main research index.html for /research/
          cp research/index.html _site/research/index.html
          
          # Copy results directory (PTC and TCC)
          mkdir -p _site/results
          cp -r results/ptc _site/results/
          if [ -d "results/tcc" ]; then
            cp -r results/tcc _site/results/
          fi
          echo "âœ… Copied results/ directory"
          
          # Create .nojekyll to bypass Jekyll processing
          touch _site/.nojekyll
          
          # Summary
          echo ""
          echo "ï¿½ Site structure:"
          ls -lh _site/
          echo ""
          echo "ğŸ“Š Research structure:"
          ls -lh _site/research/exports/
          echo ""
          echo "ğŸ“„ Results structure:"
          ls -lh _site/results/
          echo ""
          echo "âœ… Site prepared successfully"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
